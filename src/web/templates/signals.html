{% extends "base.html" %}

{% block title %}Торговые Сигналы - BingX Trading Bot{% endblock %}

{% block page_title %}Торговые Сигналы{% endblock %}

{% block extra_css %}
<style>
.signal-card {
    transition: all 0.3s ease;
    border-left: 4px solid;
}
.signal-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.signal-long {
    border-left-color: #28a745 !important;
}
.signal-short {
    border-left-color: #dc3545 !important;
}
.signal-confidence {
    font-weight: bold;
}
.confidence-high {
    color: #28a745;
}
.confidence-medium {
    color: #ffc107;
}
.confidence-low {
    color: #dc3545;
}
.signal-actions {
    opacity: 0;
    transition: opacity 0.3s ease;
}
.signal-card:hover .signal-actions {
    opacity: 1;
}
.badge-custom {
    font-size: 0.75em;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <!-- Фильтры и управление -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="btn-group me-2 mb-2">
                            <button class="btn btn-outline-primary active" data-filter="all">
                                <i class="fas fa-list"></i> Все сигналы
                            </button>
                            <button class="btn btn-outline-success" data-filter="long">
                                <i class="fas fa-arrow-up"></i> LONG
                            </button>
                            <button class="btn btn-outline-danger" data-filter="short">
                                <i class="fas fa-arrow-down"></i> SHORT
                            </button>
                        </div>
                        <div class="btn-group me-2 mb-2">
                            <button class="btn btn-outline-secondary" data-timeframe="all">
                                Все таймфреймы
                            </button>
                            <button class="btn btn-outline-secondary" data-timeframe="15m">
                                15m
                            </button>
                            <button class="btn btn-outline-secondary" data-timeframe="1h">
                                1h
                            </button>
                            <button class="btn btn-outline-secondary" data-timeframe="4h">
                                4h
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" placeholder="Поиск по символу..." id="signalSearch">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Статистика сигналов -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-signal"></i> Всего сигналов</h5>
                        <h2 id="total-signals">0</h2>
                        <p class="card-text">за последние 24 часа</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-arrow-up"></i> LONG сигналы</h5>
                        <h2 id="long-signals">0</h2>
                        <p class="card-text">процент успеха: <span id="long-success-rate">0%</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-arrow-down"></i> SHORT сигналы</h5>
                        <h2 id="short-signals">0</h2>
                        <p class="card-text">процент успеха: <span id="short-success-rate">0%</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-chart-line"></i> Общая эффективность</h5>
                        <h2 id="success-rate">0%</h2>
                        <p class="card-text">средняя прибыль: <span id="avg-profit">0.00%</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Список сигналов -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list-alt"></i> История сигналов
                    <span class="badge bg-secondary ms-2" id="signals-count">0</span>
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0" id="signals-table">
                        <thead class="table-light">
                            <tr>
                                <th>Время</th>
                                <th>Символ</th>
                                <th>Таймфрейм</th>
                                <th>Направление</th>
                                <th>Цена входа</th>
                                <th>Стоп-Лосс</th>
                                <th>Тейк-Профит</th>
                                <th>R/R</th>
                                <th>Уверенность</th>
                                <th>Результат</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="signals-list">
                            <!-- Сигналы будут загружены через JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="text-muted">Показано <span id="shown-count">0</span> из <span id="total-count">0</span> сигналов</span>
                    </div>
                    <div>
                        <button class="btn btn-outline-secondary btn-sm" id="load-more">
                            <i class="fas fa-chevron-down"></i> Загрузить еще
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для деталей сигнала -->
<div class="modal fade" id="signalDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детали торгового сигнала</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="signal-details-content">
                <!-- Контент будет загружен через JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="execute-manual-trade">
                    <i class="fas fa-play-circle"></i> Исполнить вручную
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Конфигурация
let currentPage = 1;
const signalsPerPage = 20;
let allSignals = [];
let filteredSignals = [];

// Загрузка сигналов
function loadSignals(page = 1) {
    $.ajax({
        url: '/api/signals',
        method: 'GET',
        data: { page: page, limit: signalsPerPage },
        success: function(response) {
            if (page === 1) {
                allSignals = response.signals || [];
            } else {
                allSignals = [...allSignals, ...(response.signals || [])];
            }
            
            applyFilters();
            updateStats(response.stats);
            
            if (response.signals && response.signals.length === signalsPerPage) {
                $('#load-more').show();
            } else {
                $('#load-more').hide();
            }
        },
        error: function(xhr, status, error) {
            console.error('Ошибка загрузки сигналов:', error);
            showAlert('Ошибка загрузки сигналов', 'danger');
        }
    });
}

// Применение фильтров
function applyFilters() {
    const directionFilter = $('.btn-group button[data-filter].active').data('filter');
    const timeframeFilter = $('.btn-group button[data-timeframe].active').data('timeframe');
    const searchTerm = $('#signalSearch').val().toLowerCase();
    
    filteredSignals = allSignals.filter(signal => {
        // Фильтр по направлению
        if (directionFilter !== 'all' && signal.direction !== directionFilter.toUpperCase()) {
            return false;
        }
        
        // Фильтр по таймфрейму
        if (timeframeFilter !== 'all' && signal.timeframe !== timeframeFilter) {
            return false;
        }
        
        // Поиск по символу
        if (searchTerm && !signal.symbol.toLowerCase().includes(searchTerm)) {
            return false;
        }
        
        return true;
    });
    
    renderSignals();
}

// Отрисовка сигналов в таблице
function renderSignals() {
    const tbody = $('#signals-list');
    tbody.empty();
    
    if (filteredSignals.length === 0) {
        tbody.append(`
            <tr>
                <td colspan="11" class="text-center py-4 text-muted">
                    <i class="fas fa-inbox fa-2x mb-2"></i><br>
                    Сигналы не найдены
                </td>
            </tr>
        `);
        return;
    }
    
    filteredSignals.forEach(signal => {
        const confidenceClass = signal.confidence >= 80 ? 'confidence-high' : 
                              signal.confidence >= 60 ? 'confidence-medium' : 'confidence-low';
        
        const resultBadge = signal.result === 'win' ? 
            '<span class="badge bg-success">ПОБЕДА</span>' :
            signal.result === 'loss' ? 
            '<span class="badge bg-danger">ПРОИГРЫШ</span>' :
            '<span class="badge bg-secondary">ОЖИДАНИЕ</span>';
        
        tbody.append(`
            <tr class="signal-row ${signal.direction.toLowerCase()}-signal">
                <td>${new Date(signal.timestamp).toLocaleString()}</td>
                <td><strong>${signal.symbol}</strong></td>
                <td><span class="badge bg-secondary">${signal.timeframe}</span></td>
                <td>
                    ${signal.direction === 'LONG' ? 
                      '<span class="badge bg-success"><i class="fas fa-arrow-up"></i> LONG</span>' : 
                      '<span class="badge bg-danger"><i class="fas fa-arrow-down"></i> SHORT</span>'}
                </td>
                <td>$${signal.price.toFixed(2)}</td>
                <td>$${signal.stop_loss.toFixed(2)}</td>
                <td>$${signal.take_profit.toFixed(2)}</td>
                <td>${signal.risk_reward.toFixed(2)}:1</td>
                <td>
                    <span class="signal-confidence ${confidenceClass}">
                        ${signal.confidence}%
                    </span>
                </td>
                <td>${resultBadge}</td>
                <td>
                    <div class="btn-group btn-group-sm signal-actions">
                        <button class="btn btn-outline-primary view-signal" data-id="${signal.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-success execute-signal" data-id="${signal.id}">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `);
    });
    
    $('#shown-count').text(filteredSignals.length);
    $('#total-count').text(allSignals.length);
}

// Обновление статистики
function updateStats(stats) {
    if (!stats) return;
    
    $('#total-signals').text(stats.total_signals || 0);
    $('#long-signals').text(stats.long_signals || 0);
    $('#short-signals').text(stats.short_signals || 0);
    $('#long-success-rate').text((stats.long_success_rate || 0) + '%');
    $('#short-success-rate').text((stats.short_success_rate || 0) + '%');
    $('#success-rate').text((stats.success_rate || 0) + '%');
    $('#avg-profit').text((stats.avg_profit || 0).toFixed(2) + '%');
}

// Показать детали сигнала
function showSignalDetails(signalId) {
    const signal = allSignals.find(s => s.id === signalId);
    if (!signal) return;
    
    const reasonsList = signal.reasons ? signal.reasons.map(r => `<li>${r}</li>`).join('') : '';
    
    $('#signal-details-content').html(`
        <div class="row">
            <div class="col-md-6">
                <h5>Основная информация</h5>
                <table class="table table-sm">
                    <tr>
                        <th>Символ:</th>
                        <td>${signal.symbol}</td>
                    </tr>
                    <tr>
                        <th>Таймфрейм:</th>
                        <td>${signal.timeframe}</td>
                    </tr>
                    <tr>
                        <th>Направление:</th>
                        <td>${signal.direction === 'LONG' ? 
                             '<span class="badge bg-success">LONG</span>' : 
                             '<span class="badge bg-danger">SHORT</span>'}</td>
                    </tr>
                    <tr>
                        <th>Цена входа:</th>
                        <td>$${signal.price.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <th>Стоп-Лосс:</th>
                        <td>$${signal.stop_loss.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <th>Тейк-Профит:</th>
                        <td>$${signal.take_profit.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <th>R/R соотношение:</th>
                        <td>${signal.risk_reward.toFixed(2)}:1</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <h5>Анализ и показатели</h5>
                <table class="table table-sm">
                    <tr>
                        <th>Уверенность:</th>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar" style="width: ${signal.confidence}%">
                                    ${signal.confidence}%
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>Размер позиции:</th>
                        <td>${signal.position_size || 'N/A'}</td>
                    </tr>
                    <tr>
                        <th>Время сигнала:</th>
                        <td>${new Date(signal.timestamp).toLocaleString()}</td>
                    </tr>
                    <tr>
                        <th>Статус:</th>
                        <td>
                            ${signal.result === 'win' ? 
                              '<span class="badge bg-success">ПОБЕДА</span>' :
                              signal.result === 'loss' ? 
                              '<span class="badge bg-danger">ПРОИГРЫШ</span>' :
                              '<span class="badge bg-secondary">ОЖИДАНИЕ</span>'}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <h5>Обоснование сигнала</h5>
                <ul>
                    ${reasonsList || '<li>Информация отсутствует</li>'}
                </ul>
            </div>
        </div>
        ${signal.indicators ? `
        <div class="row mt-3">
            <div class="col-md-12">
                <h5>Показатели индикаторов</h5>
                <pre class="bg-light p-3">${JSON.stringify(signal.indicators, null, 2)}</pre>
            </div>
        </div>
        ` : ''}
    `);
    
    $('#signalDetailsModal').modal('show');
}

// Инициализация при загрузке страницы
$(document).ready(function() {
    // Загрузка сигналов
    loadSignals();
    
    // Обработчики фильтров
    $('.btn-group button[data-filter]').click(function() {
        $('.btn-group button[data-filter]').removeClass('active');
        $(this).addClass('active');
        applyFilters();
    });
    
    $('.btn-group button[data-timeframe]').click(function() {
        $('.btn-group button[data-timeframe]').removeClass('active');
        $(this).addClass('active');
        applyFilters();
    });
    
    // Поиск
    $('#signalSearch').on('input', function() {
        applyFilters();
    });
    
    // Загрузка дополнительных сигналов
    $('#load-more').click(function() {
        currentPage++;
        loadSignals(currentPage);
    });
    
    // Просмотр деталей сигнала
    $(document).on('click', '.view-signal', function() {
        const signalId = $(this).data('id');
        showSignalDetails(signalId);
    });
    
    // Исполнение сигнала
    $(document).on('click', '.execute-signal', function() {
        const signalId = $(this).data('id');
        const signal = allSignals.find(s => s.id === signalId);
        
        if (confirm(`Исполнить сигнал ${signal.symbol} ${signal.direction}?`)) {
            $.ajax({
                url: `/api/execute/${signal.symbol}/${signal.direction}`,
                method: 'POST',
                data: {
                    price: signal.price,
                    stop_loss: signal.stop_loss,
                    take_profit: signal.take_profit,
                    quantity: signal.position_size
                },
                success: function(response) {
                    showAlert('Сигнал успешно исполнен', 'success');
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка исполнения сигнала:', error);
                    showAlert('Ошибка исполнения сигнала', 'danger');
                }
            });
        }
    });
    
    // Исполнение вручную из модального окна
    $('#execute-manual-trade').click(function() {
        $('#signalDetailsModal').modal('hide');
        // Здесь будет логика исполнения сделки
        showAlert('Торговая операция запущена', 'info');
    });
});

// Автообновление каждые 30 секунд
setInterval(function() {
    if ($('#signals-table').is(':visible')) {
        loadSignals(1);
    }
}, 30000);
</script>
{% endblock %}